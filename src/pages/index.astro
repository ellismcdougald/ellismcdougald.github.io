---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Nav from '../components/Nav.astro'
import { getEntry, getCollection } from 'astro:content';

const entry = await getEntry('site', 'site');
const site = entry?.data ?? {};
const projectsCollection = await getCollection('projects');
const projectMap = new Map(projectsCollection.map((e: any) => [e.slug, e]));
const slugify = (s: string) =>
  String(s)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');

const normalizeUrl = (u: string | null) => {
  if (!u) return null;
  return /^https?:\/\//i.test(u) ? u : `https://${u}`;
};

const featuredProjects = (site.projects || [])
  .filter((p: any) => p.featured)
  .map((p: any) => {
    const postSlug = p.post ?? slugify(p.name);
    const postEntry = projectMap.get(postSlug);
    const githubRaw = p.github ?? postEntry?.data?.github ?? null;
    const github = normalizeUrl(githubRaw);
    const websiteRaw = p.website ?? postEntry?.data?.website ?? null;
    const website = normalizeUrl(websiteRaw);
    return { ...p, postSlug, hasPost: projectMap.has(postSlug), github, website };
  });
const otherProjects = (site.projects || [])
  .filter((p: any) => !p.featured)
  .map((p: any) => {
    const postSlug = p.post ?? slugify(p.name);
    const postEntry = projectMap.get(postSlug);
    const githubRaw = p.github ?? postEntry?.data?.github ?? null;
    const github = normalizeUrl(githubRaw);
    const websiteRaw = p.website ?? postEntry?.data?.website ?? null;
    const website = normalizeUrl(websiteRaw);
    return { ...p, postSlug, hasPost: projectMap.has(postSlug), github, website };
  });

---

<Layout>
  <Nav />
  <main id="top" class="container">
    <Header name={site.name} subtitle={site.subtitle} />

    <section id="summary" class="section">
      <h2>About Me</h2>
      <div class="card">{site.summary}</div>
    </section>

    <section id="education" class="section">
      <h2>Education</h2>
      {Array.isArray(site.education) ? (
        site.education.map((ed: any) => (
          <div class="card">
            <strong>{ed.degree}</strong>
            <div class="meta">{ed.school} — {ed.years}</div>
            {Array.isArray(ed.blurb) && (
              <ul>
                {ed.blurb.map((b: string) => (
                  <li>{b}</li>
                ))}
              </ul>
            )}
          </div>
        ))
      ) : (
        <div class="card">
          <strong>{site.education?.degree}</strong>
          <div class="meta">{site.education?.school} — {site.education?.years}</div>
          {Array.isArray(site.education?.blurb) && (
            <ul>
              {site.education.blurb.map((b: string) => (
                <li>{b}</li>
              ))}
            </ul>
          )}
        </div>
      )}
    </section>

    <section id="experience" class="section">
      <h2>Experience</h2>
      {site.experience?.map((e: any) => (
        <div class="card">
          <strong>{e.role}</strong>
          <div class="meta">{e.org} — {e.years}</div>
          {Array.isArray(e.blurb) ? (
            <ul>
              {e.blurb.map((item: string) => (
                <li>{item}</li>
              ))}
            </ul>
          ) : (
            <p>{e.blurb}</p>
          )}
        </div>
      ))}
    </section>

    <section id="projects" class="section">
      <h2>Projects</h2>
      {featuredProjects?.length ? (
        <div class="project-list featured-list">
          {featuredProjects.map((p: any) => (
            <div class="card">
              <strong><span class="star">★</span>{p.name}</strong>
              <div class="meta">{p.tech}</div>
              {Array.isArray(p.desc) ? (
                <ul>
                  {p.desc.map((d: string) => (
                    <li>{d}</li>
                  ))}
                </ul>
              ) : (
                <p>{p.desc}</p>
              )}
              <div class="card-footer-actions">
                {p.github && (
                  <a class="repo-link" href={p.github} target="_blank" rel="noopener noreferrer">GitHub</a>
                )}
                {p.github && (p.website || p.hasPost) && <span class="sep">·</span>}
                {p.website && (
                  <a class="site-link" href={p.website} target="_blank" rel="noopener noreferrer">Website</a>
                )}
                {(p.website && p.hasPost) && <span class="sep">·</span>}
                {p.hasPost && (
                  <a class="read-more" href={`/projects/${p.postSlug}`}>What I Learned</a>
                )}
              </div>
            </div>
          ))}
        </div>
      ) : null}

      {otherProjects?.length ? (
        <>
          <button id="toggle-projects" class="expand-btn">Show {otherProjects.length} more</button>
          <div id="more-projects" class="project-list more-projects hidden">
            {otherProjects.map((p: any) => (
              <div class="card">
                <strong>{p.name}</strong>
                <div class="meta">{p.tech}</div>
                {Array.isArray(p.desc) ? (
                  <ul>
                    {p.desc.map((d: string) => (
                      <li>{d}</li>
                    ))}
                  </ul>
                ) : (
                  <p>{p.desc}</p>
                )}
                <div class="card-footer-actions">
                    {p.github && (
                      <a class="repo-link" href={p.github} target="_blank" rel="noopener noreferrer">GitHub</a>
                    )}
                    {p.github && (p.website || p.hasPost) && <span class="sep">·</span>}
                    {p.website && (
                      <a class="site-link" href={p.website} target="_blank" rel="noopener noreferrer">Website</a>
                    )}
                    {(p.website && p.hasPost) && <span class="sep">·</span>}
                    {p.hasPost && (
                      <a class="read-more" href={`/projects/${p.postSlug}`}>Read More</a>
                    )}
                </div>
              </div>
            ))}
          </div>
        </>
      ) : null}
    </section>
    <script type="module">
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('toggle-projects');
        const more = document.getElementById('more-projects');
        if (!btn || !more) return;
        btn.addEventListener('click', () => {
          const isHidden = more.classList.toggle('hidden');
          btn.textContent = isHidden ? `Show ${more.querySelectorAll('.card').length} more` : 'Hide projects';
        });
      });
    </script>

    <section id="contact" class="section">
      <h2>Contact</h2>
      <div class="card contact">
        <div>Email: <a href={`mailto:${site.contact?.email}`}>{site.contact?.email}</a></div>
        <div>GitHub: <a href={site.contact?.github} target="_blank">{site.contact?.github?.replace('https://github.com/', '')}</a></div>
        <div>LinkedIn: <a href={site.contact?.linkedin} target="_blank">{site.contact?.linkedin?.replace('https://www.linkedin.com/in/', '')}</a></div>
      </div>
    </section>
  </main>
</Layout>
